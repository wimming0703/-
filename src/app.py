import streamlit as st
import pandas as pd
import numpy as np
from io import StringIO

st.set_page_config(page_title="ìì·¨ìƒì˜ ëƒ‰ì¥ê³  íŒŒë¨¹ê¸°", page_icon="ğŸ¥—", layout="centered")
st.title("ìì·¨ìƒì˜ ëƒ‰ì¥ê³  íŒŒë¨¹ê¸°")

# =========================
# 1) ë‚´ì¥ ë°ì´í„° (ë©”ë‰´/ì¬ë£Œ)
# =========================
CSV_TEXT = """title,ingredients
ê¹€ì¹˜ë³¶ìŒë°¥,ë°¥;ê¹€ì¹˜;ëŒ€íŒŒ;ê³„ë€;ì°¸ê¸°ë¦„
ê³„ë€ì¥ì¡°ë¦¼,ê³„ë€;ê°„ì¥;ì„¤íƒ•;ë¬¼;ê³ ì¶”
ì°¸ì¹˜ë§ˆìš”ë®ë°¥,ë°¥;ì°¸ì¹˜ìº”;ë§ˆìš”ë„¤ì¦ˆ;ê°„ì¥;ëŒ€íŒŒ
ëœì¥ì°Œê°œ,ëœì¥;ë‘ë¶€;ì–‘íŒŒ;ê°ì;ì• í˜¸ë°•;ëŒ€íŒŒ
ì˜¤ì¼íŒŒìŠ¤íƒ€,ìŠ¤íŒŒê²Œí‹°ë©´;ì˜¬ë¦¬ë¸Œì˜¤ì¼;ë§ˆëŠ˜;ì†Œê¸ˆ;í›„ì¶”
ì‚¼ê²¹ì‚´ìˆ™ì£¼ë³¶ìŒ,ì‚¼ê²¹ì‚´;ìˆ™ì£¼;ê°„ì¥;êµ´ì†ŒìŠ¤;í›„ì¶”
ë–¡ë³¶ì´(ì—½ë–¡ìŠ¤íƒ€ì¼),ë–¡;ê³ ì¶”ì¥;ê³ ì¶§ê°€ë£¨;ì„¤íƒ•;ì–´ë¬µ;ëŒ€íŒŒ
í¸ì˜ì ì¡°í•©(ì‚¼ê°ê¹€ë°¥+ì»µë¼ë©´),ì‚¼ê°ê¹€ë°¥;ì»µë¼ë©´

ê°„ì¥ê³„ë€ë°¥,ë°¥;ê³„ë€;ê°„ì¥;ì°¸ê¸°ë¦„
ë¼ë©´ì¹˜ì¦ˆê³„ë€,ë¼ë©´ì‚¬ë¦¬;ë¼ë©´ìŠ¤í”„;ê³„ë€;ìŠ¬ë¼ì´ìŠ¤ì¹˜ì¦ˆ;ëŒ€íŒŒ
ë–¡ë¼ë©´,ë¼ë©´ì‚¬ë¦¬;ë¼ë©´ìŠ¤í”„;ë–¡;ëŒ€íŒŒ
ì¹˜ì¦ˆê³„ë€í† ìŠ¤íŠ¸,ì‹ë¹µ;ê³„ë€;ìŠ¬ë¼ì´ìŠ¤ì¹˜ì¦ˆ;ë²„í„°;ì¼€ì²©
ì°¸ì¹˜ë§ˆìš”ì£¼ë¨¹ë°¥,ë°¥;ì°¸ì¹˜ìº”;ë§ˆìš”ë„¤ì¦ˆ;ê¹€;ì†Œê¸ˆ
ë¹„ë¹”êµ­ìˆ˜,ì†Œë©´;ê³ ì¶”ì¥;ì‹ì´ˆ;ì„¤íƒ•;ì°¸ê¸°ë¦„;ì˜¤ì´;ê³„ë€
í† ë§ˆí† ê³„ë€ë³¶ìŒ,í† ë§ˆí† ;ê³„ë€;ëŒ€íŒŒ;ì†Œê¸ˆ;í›„ì¶”;ì‹ìš©ìœ 
ê¹€ì¹˜ì „,ê¹€ì¹˜;ë¶€ì¹¨ê°€ë£¨;ë¬¼;ì‹ìš©ìœ 
ë¶€ì¹¨ê°œ(ì•¼ì±„),ë¶€ì¹¨ê°€ë£¨;ì–‘íŒŒ;ë‹¹ê·¼;ëŒ€íŒŒ;ë¬¼;ì‹ìš©ìœ 
ì–´ë¬µë³¶ìŒ,ì–´ë¬µ;ì–‘íŒŒ;ë‹¹ê·¼;ê°„ì¥;ì„¤íƒ•;ë¬¼ì—¿;ë§ˆëŠ˜;ì‹ìš©ìœ 
ìŠ¤íŒ¸êµ¬ì´ì •ì‹,ìŠ¤íŒ¸;ë°¥;ê³„ë€;ê¹€;ê¹€ì¹˜
ì†Œì‹œì§€ì•¼ì±„ë³¶ìŒ,ì†Œì‹œì§€;ì–‘íŒŒ;ë‹¹ê·¼;í”¼ë§;ê°„ì¥;ì„¤íƒ•;í›„ì¶”;ì‹ìš©ìœ 
ìŠ¤íŒ¸ë§ˆìš”ë®ë°¥,ë°¥;ìŠ¤íŒ¸;ë§ˆìš”ë„¤ì¦ˆ;ê°„ì¥;ëŒ€íŒŒ
ê¹€ì¹˜ì°¸ì¹˜ë³¶ìŒë°¥,ë°¥;ê¹€ì¹˜;ì°¸ì¹˜ìº”;ëŒ€íŒŒ;ì°¸ê¸°ë¦„
í•«ë„ê·¸(ìì·¨ë²„ì „),í•«ë„ê·¸ë¹µ;ì†Œì‹œì§€;ì¼€ì²©;ë¨¸ìŠ¤í„°ë“œ
ì½˜ì¹˜ì¦ˆ,ì˜¥ìˆ˜ìˆ˜ì½˜;ë§ˆìš”ë„¤ì¦ˆ;ì„¤íƒ•;ëª¨ì§œë ë¼ì¹˜ì¦ˆ;ë²„í„°

ì œìœ¡ë³¶ìŒ,ë¼ì§€ê³ ê¸°ì•ë‹¤ë¦¬;ì–‘íŒŒ;ëŒ€íŒŒ;ê³ ì¶”ì¥;ê°„ì¥;ì„¤íƒ•;ê³ ì¶§ê°€ë£¨;ë§ˆëŠ˜;í›„ì¶”;ì‹ìš©ìœ 
ê°ìê³„ë€ë³¶ìŒ,ê°ì;ê³„ë€;ì–‘íŒŒ;ì†Œê¸ˆ;í›„ì¶”;ì‹ìš©ìœ 
ì¹´ë ˆë¼ì´ìŠ¤,ë°¥;ì¹´ë ˆê°€ë£¨;ê°ì;ì–‘íŒŒ;ë‹¹ê·¼;ì‹ìš©ìœ ;ë¬¼
ë¶€ëŒ€ì°Œê°œ,ì†Œì‹œì§€;ìŠ¤íŒ¸;ê¹€ì¹˜;ë‘ë¶€;ì–‘íŒŒ;ê³ ì¶”ì¥;ê³ ì¶§ê°€ë£¨;ë§ˆëŠ˜;ë¼ë©´ì‚¬ë¦¬;ëŒ€íŒŒ;êµ­ë¬¼ìš©ë©¸ì¹˜;ë¬¼
ìˆœë‘ë¶€ì°Œê°œ,ìˆœë‘ë¶€;ë¼ì§€ê³ ê¸°ë‹¤ì§;ì–‘íŒŒ;ëŒ€íŒŒ;ê³ ì¶§ê°€ë£¨;ê°„ì¥;ë§ˆëŠ˜;ê³„ë€;ë¬¼
êµ­ë¬¼ë–¡ë³¶ì´,ë–¡;ì–´ë¬µ;ëŒ€íŒŒ;ê³ ì¶”ì¥;ê°„ì¥;ì„¤íƒ•;ë‹¤ì‹œë‹¤;ë¬¼
ë¡œì œë–¡ë³¶ì´,ë–¡;ì–´ë¬µ;ìš°ìœ ;ìƒí¬ë¦¼;ê³ ì¶”ì¥;ì„¤íƒ•;í›„ì¶”;ë²„í„°

í† ë§ˆí† íŒŒìŠ¤íƒ€,ìŠ¤íŒŒê²Œí‹°ë©´;í† ë§ˆí† íŒŒìŠ¤íƒ€ì†ŒìŠ¤;ì–‘íŒŒ;ë§ˆëŠ˜;ì˜¬ë¦¬ë¸Œì˜¤ì¼;ì†Œê¸ˆ;í›„ì¶”
í¬ë¦¼ë² ì´ì»¨íŒŒìŠ¤íƒ€,ìŠ¤íŒŒê²Œí‹°ë©´;ë² ì´ì»¨;ìƒí¬ë¦¼;ìš°ìœ ;ì–‘íŒŒ;ë§ˆëŠ˜;ë²„í„°;ì†Œê¸ˆ;í›„ì¶”
í˜í˜ë¡ ì¹˜ë…¸,ìŠ¤íŒŒê²Œí‹°ë©´;ì˜¬ë¦¬ë¸Œì˜¤ì¼;ë§ˆëŠ˜;í˜í˜ë¡ ì¹˜ë…¸;ì†Œê¸ˆ

í¸ì˜ì (ìƒëŸ¬ë“œ+ë‹­ê°€ìŠ´ì‚´),ìƒëŸ¬ë“œ;í›ˆì œë‹­ê°€ìŠ´ì‚´
í¸ì˜ì (í–‡ë°˜+ì°¸ì¹˜+ë§ˆìš”),ì¦‰ì„ë°¥;ì°¸ì¹˜ìº”;ë§ˆìš”ë„¤ì¦ˆ;ê°„ì¥
í¸ì˜ì (ì»µêµ­+ì¦‰ì„ë°¥),ì»µêµ­;ì¦‰ì„ë°¥
ì»µë¼ë©´+ì¹˜ì¦ˆ+ê¹€,ì»µë¼ë©´;ìŠ¬ë¼ì´ìŠ¤ì¹˜ì¦ˆ;ê¹€
"""

df = pd.read_csv(StringIO(CSV_TEXT))
df["ing_list"] = df["ingredients"].apply(lambda s: [x.strip() for x in str(s).split(";") if x and x.strip()])

# ê¸°ë³¸ ì¬ë£Œ ê°€ì¤‘ì¹˜(ìŠ¬ë¼ì´ë” ê¸°ë³¸ê°’ì— ì‚¬ìš©)
DEFAULT_PANTRY = {
    "ë°¥": 1.0, "ì¦‰ì„ë°¥": 1.0, "ì†Œë©´": 1.0, "ìŠ¤íŒŒê²Œí‹°ë©´": 1.0, "ì‹ë¹µ": 1.0, "ë¼ë©´ì‚¬ë¦¬": 1.0,

    "ê³„ë€": 1.0, "ë‘ë¶€": 1.0, "ìˆœë‘ë¶€": 1.0, "ì‚¼ê²¹ì‚´": 1.0, "ë¼ì§€ê³ ê¸°ì•ë‹¤ë¦¬": 1.0,
    "ì†Œì‹œì§€": 1.0, "ìŠ¤íŒ¸": 1.0, "ë² ì´ì»¨": 1.0, "ì°¸ì¹˜ìº”": 1.0, "í›ˆì œë‹­ê°€ìŠ´ì‚´": 1.0,
  
    "ì–‘íŒŒ": 1.0, "ëŒ€íŒŒ": 1.0, "ê°ì": 1.0, "ë‹¹ê·¼": 1.0, "ì• í˜¸ë°•": 1.0, "í”¼ë§": 1.0, "ì˜¤ì´": 1.0,
    "ê¹€ì¹˜": 1.0, "ê¹€": 1.0, "ê³ ì¶”": 1.0, "ìƒëŸ¬ë“œ": 1.0, "í† ë§ˆí† ": 1.0, "ìˆ™ì£¼": 1.0,

    "ë–¡": 1.0, "ì–´ë¬µ": 1.0,
 
    "ìš°ìœ ": 1.0, "ìƒí¬ë¦¼": 1.0, "ìŠ¬ë¼ì´ìŠ¤ì¹˜ì¦ˆ": 1.0, "ëª¨ì§œë ë¼ì¹˜ì¦ˆ": 1.0, "ë²„í„°": 1.0,
  
    "ì˜¥ìˆ˜ìˆ˜ì½˜": 1.0, "í•«ë„ê·¸ë¹µ": 1.0,

    "ê°„ì¥": 1.0, "ê³ ì¶”ì¥": 1.0, "ê³ ì¶§ê°€ë£¨": 1.0, "ëœì¥": 1.0, "ì„¤íƒ•": 1.0, "ì‹ì´ˆ": 1.0,
    "ì°¸ê¸°ë¦„": 1.0, "êµ´ì†ŒìŠ¤": 1.0, "ë§ˆìš”ë„¤ì¦ˆ": 1.0, "ì¼€ì²©": 1.0, "ë¨¸ìŠ¤í„°ë“œ": 1.0,
    "í›„ì¶”": 1.0, "ì†Œê¸ˆ": 1.0, "ë§ˆëŠ˜": 1.0, "ë‹¤ì§„ë§ˆëŠ˜": 1.0, "ì˜¬ë¦¬ë¸Œì˜¤ì¼": 1.0, "ì‹ìš©ìœ ": 1.0,
    "ë¼ë©´ìŠ¤í”„": 1.0, "ë¬¼ì—¿": 1.0, "ë§›ìˆ ": 1.0, "ë‹¤ì‹œë‹¤": 1.0,

    "ë¶€ì¹¨ê°€ë£¨": 1.0, "ë°€ê°€ë£¨": 1.0, "ì¹´ë ˆê°€ë£¨": 1.0,

    "í† ë§ˆí† íŒŒìŠ¤íƒ€ì†ŒìŠ¤": 1.0, "í˜í˜ë¡ ì¹˜ë…¸": 1.0,

    "ì‚¼ê°ê¹€ë°¥": 1.0, "ì»µë¼ë©´": 1.0, "ì»µêµ­": 1.0,

    "ë¬¼": 1.0
}


# =========================
# 2) ìœ í‹¸(ë²¡í„°í™”/ìœ ì‚¬ë„/ì¶”ì²œ)
# =========================
def build_vocab(lists_of_tokens):
    vocab = {}
    for lst in lists_of_tokens:
        for tok in lst:
            if tok not in vocab:
                vocab[tok] = len(vocab)
    return vocab  # {token: index}

def vectorize(list_of_lists, vocab, weights=None):
    M, D = len(list_of_lists), len(vocab)
    X = np.zeros((M, D), dtype=np.float32)
    for i, tokens in enumerate(list_of_lists):
        for t in tokens:
            j = vocab.get(t)
            if j is None:
                continue
            w = 1.0 if weights is None else float(weights.get(t, 1.0))
            X[i, j] += w
    return X

def cosine_sim(A, B):
    An = A / (np.linalg.norm(A, axis=1, keepdims=True) + 1e-8)
    Bn = B / (np.linalg.norm(B, axis=1, keepdims=True) + 1e-8)
    return An @ Bn.T

def missing_ingredients(pantry_set, need_list):
    return [x for x in need_list if x not in pantry_set]

def recommend(U, R, k=5, penalty=None, penalty_strength=0.1):
    S = cosine_sim(U, R).reshape(-1)
    if penalty is not None:
        S = S - penalty_strength * penalty  # ë¶€ì¡± ì¬ë£Œ ê°œìˆ˜ë§Œí¼ ì ìˆ˜ ê¹ê¸°
    idx = np.argsort(-S)[:k]
    return idx, S[idx]

# ==========================================
# 3) UI â€” ë¹ˆ ìƒíƒœ ì‹œì‘ + ì‹¤ì‹œê°„ ì¬ë£Œ ì¶”ê°€/í•´ì œ
# ==========================================
st.subheader("ë‚´ ì¬ë£Œ ì„ íƒ")

# ë ˆì‹œí”¼ì—ì„œ ë“±ì¥í•˜ëŠ” ì¬ë£Œ + ê¸°ë³¸ì°½ê³  ì¬ë£Œ â†’ í›„ë³´ í’€
all_ings_base = sorted({w for lst in df["ing_list"] for w in lst} | set(DEFAULT_PANTRY.keys()))

# ì„¸ì…˜ ìƒíƒœ ì´ˆê¸°í™” (ë¹ˆ ìƒíƒœ ì‹œì‘)
if "my_ings" not in st.session_state:
    st.session_state["my_ings"] = []           # í˜„ì¬ ì„ íƒëœ ë‚˜ì˜ ì¬ë£Œ(ë¹ˆ ëª©ë¡ìœ¼ë¡œ ì‹œì‘)
if "all_ings" not in st.session_state:
    st.session_state["all_ings"] = list(all_ings_base)  # í›„ë³´ ì¬ë£Œ ëª©ë¡

# ===================  ë¹ ë¥¸ ì…ë ¥/ì´ˆê¸°í™” UI ===================
# í¼ì„ ì“°ë©´ ì…ë ¥ì¹¸ + ë²„íŠ¼ì´ ê°™ì€ ì¤„ì—ì„œ ë³´ê¸° ì¢‹ê²Œ ì •ë ¬,
# Enter í‚¤ë¡œë„ 'ì¶”ê°€'ê°€ ë™ì‘í•©ë‹ˆë‹¤.
with st.form("quick_add_form", clear_on_submit=False):
    c1, c2, c3 = st.columns([6, 2, 2], vertical_alignment="center")

    with c1:
        # ë¼ë²¨ ê°ì¶”ê³  placeholderë§Œ ë³´ì´ê²Œ â†’ ë†’ì´/ì •ë ¬ ê¹”ë”í•˜ê²Œ...
        new_ing_text = st.text_input(
            label="ìƒˆ ì¬ë£Œ ì¶”ê°€",
            placeholder="ì˜ˆ) ë² ì´ì»¨, ì¹˜ì¦ˆ",
            label_visibility="collapsed"
        )

    with c2:
        add_clicked = st.form_submit_button("ì¶”ê°€", use_container_width=True)

    with c3:
        clear_clicked = st.form_submit_button("ëª¨ë‘ í•´ì œ", use_container_width=True)

# ì–´ë–¤ ë²„íŠ¼ì„ ëˆŒë €ëŠ”ì§€ì— ë”°ë¼ ì²˜ë¦¬
if add_clicked and new_ing_text.strip():
    to_add = [x.strip() for x in new_ing_text.split(",") if x.strip()]
    st.session_state["all_ings"] = sorted(set(st.session_state["all_ings"]) | set(to_add))
    st.session_state["my_ings"] = sorted(set(st.session_state["my_ings"]) | set(to_add))
    st.rerun()

if clear_clicked:
    st.session_state["my_ings"] = []
    st.rerun()

# ë©€í‹°ì…€ë ‰íŠ¸(ì„¸ì…˜ ìƒíƒœì™€ ì—°ê²°)
selected_ings = st.multiselect(
    "ë³´ìœ  ì¬ë£Œë¥¼ ê³¨ë¼ì£¼ì„¸ìš”",
    options=st.session_state["all_ings"],
    default=st.session_state["my_ings"],
    key="my_ings"
)

st.caption("ê°€ì¤‘ì¹˜(ìˆ˜ëŸ‰/ì„ í˜¸) ì¡°ì ˆ")
weights = {}
cols = st.columns(3)
for i, ing in enumerate(st.session_state["my_ings"]):
    with cols[i % 3]:
        weights[ing] = st.slider(ing, 0.0, 5.0, float(DEFAULT_PANTRY.get(ing, 1.0)), 0.1)

topk = st.slider("ì¶”ì²œ ê°œìˆ˜ (Top-K)", 1, 10, 5)
use_penalty = st.checkbox("ë¶€ì¡± ì¬ë£Œ í˜ë„í‹° ì ìš©", value=True)
penalty_strength = st.slider("í˜ë„í‹° ê°•ë„", 0.0, 0.5, 0.1, 0.05)

# =========================
# 4) ì¶”ì²œ ê³„ì‚° ë° ì¶œë ¥
# =========================
if len(st.session_state["my_ings"]) == 0:
    st.warning("ì¬ë£Œë¥¼ í•˜ë‚˜ ì´ìƒ ì„ íƒí•˜ê±°ë‚˜, ìœ„ ì…ë ¥ì°½ì— ìƒˆ ì¬ë£Œë¥¼ ì¶”ê°€í•´ ì£¼ì„¸ìš”.")
else:
    vocab = build_vocab(df["ing_list"].tolist() + [st.session_state["my_ings"]])
    R = vectorize(df["ing_list"].tolist(), vocab)                               # (N, D)
    U = vectorize([st.session_state["my_ings"]], vocab, weights=weights)        # (1, D)

    pantry_set = set(st.session_state["my_ings"])
    penalty_vec = None
    if use_penalty:
        penalty_vec = np.array(
            [len(missing_ingredients(pantry_set, lst)) for lst in df["ing_list"]],
            dtype=np.float32
        )

    idx, scores = recommend(U, R, k=topk, penalty=penalty_vec, penalty_strength=penalty_strength)

    st.subheader(f"ì¶”ì²œ ë ˆì‹œí”¼ Top-{topk}")
    for rank, (i, sc) in enumerate(zip(idx.tolist(), scores.tolist()), start=1):
        row = df.iloc[i]
        miss = missing_ingredients(pantry_set, row["ing_list"])
        st.markdown(f"**[{rank}] {row['title']}** â€” score: `{sc:.4f}`")
        st.caption("í•„ìš”í•œ ì¬ë£Œ: " + ", ".join(row["ing_list"]))
        if miss:
            st.error("ë¶€ì¡±í•œ ì¬ë£Œ: " + ", ".join(miss))
        else:
            st.success("ë¶€ì¡±í•œ ì¬ë£Œ: ì—†ìŒ")
        st.divider()

# (ì„ íƒ) ë””ë²„ê·¸: í˜„ì¬ í›„ë³´/ì„ íƒ ì¬ë£Œ ë³´ê¸°
with st.expander("ì¬ë£Œ í™•ì¸í•˜ê¸° !"):
    st.write("í›„ë³´ ì¬ë£Œ:", ", ".join(st.session_state["all_ings"]))
    st.write("ì„ íƒ ì¬ë£Œ:", ", ".join(st.session_state["my_ings"]))

# ì„¤ëª…
with st.expander("ì„¤ëª…"):
    st.write(
        "- í…ìŠ¤íŠ¸ ì¬ë£Œë¥¼ ë‹¨ì–´ì¥ìœ¼ë¡œ ë²¡í„°í™”í•˜ê³  ì½”ì‚¬ì¸ ìœ ì‚¬ë„ë¡œ ì¶”ì²œí•©ë‹ˆë‹¤.\n"
        "- ë¶€ì¡± ì¬ë£Œ í˜ë„í‹°ë¡œ ë§Œë“¤ê¸° ì‰¬ìš´ ë©”ë‰´ë¥¼ ìœ„ë¡œ ì˜¬ë¦½ë‹ˆë‹¤.\n"
        "- ì¬ë£Œ ê°€ì¤‘ì¹˜(ìˆ˜ëŸ‰/ì„ í˜¸) ìŠ¬ë¼ì´ë”ë¡œ ë­í‚¹ì´ ì¦‰ì‹œ ë°˜ì˜ë©ë‹ˆë‹¤.\n"
        "- ì´ ë²„ì „ì€ í˜ì´ì§€(ì„¸ì…˜) ë‚´ì—ì„œ ì¬ë£Œë¥¼ ì‹¤ì‹œê°„ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. (ë‹¨,ìƒˆë¡œê³ ì¹¨í•˜ë©´ ì´ˆê¸°í™”ë©ë‹ˆë‹¤.)"
    )
