<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>무대 연출 — Console Edition v7</title>
<link rel="icon" href="data:,">
<style>
  :root{
    --bg:#070a0f; --panel:#0a1220cc; --panel-2:#0c1620cc; --border:#ffffff22;
    --text:#eaf0ff; --muted:#a7b5d6; --accent:#88aaff; --danger:#ff6b81; --ok:#8ae9a5;
    --fs:14px; --fs-small:12px;
  }
  html,body{margin:0;height:100%;background:radial-gradient(1000px 600px at 50% 10%,#0e1631 0%,#070b14 45%,#050810 100%);color:var(--text);font-family:-apple-system,Apple SD Gothic Neo,Noto Sans KR,system-ui,sans-serif;font-size:var(--fs)}
  canvas{display:block;width:100%;height:100%}

  .sidebar{position:fixed;left:10px;top:10px;bottom:10px;width:320px;display:flex;flex-direction:column;gap:10px;z-index:40;overflow:auto}
  .panel{background:var(--panel);border:1px solid var(--border);border-radius:14px;backdrop-filter: blur(10px);
         box-shadow:0 12px 40px rgba(0,0,0,.35);padding:10px}
  .panel h1{margin:0 0 8px 0;font-size:15px;color:#dbe7ff}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .sep{height:1px;background:linear-gradient(90deg,transparent, #ffffff18 20%, #ffffff12 80%, transparent);margin:8px 0}
  button,select,input[type=range],input[type=color],label,input[type=text]{background:#0c1322;color:var(--text);
    border:1px solid var(--border);border-radius:10px;padding:6px 8px;font-weight:600;font-size:13px}
  input[type=range]{accent-color:var(--accent)}
  input[type=color]{padding:0;height:30px;width:40px;border-radius:8px}
  input[type=text]{min-width:120px}
  button{cursor:pointer;transition:transform .06s ease} button:active{transform:translateY(1px)}
  .chip{padding:5px 8px;border-radius:999px;background:#0f1a30;border:1px solid var(--border);font-size:11px;color:var(--muted)}
  .ghost{background:transparent;border-style:dashed}
  .danger{background:#2a0e13;border-color:#ff9aa7}
  .ok{border-color:var(--ok)}

  .toolbar{position:fixed;left:340px;right:10px;bottom:10px;display:flex;gap:10px;align-items:center;z-index:30;flex-wrap:wrap}
  .toolcard{background:var(--panel-2);border:1px solid var(--border);border-radius:12px;padding:8px 10px;backdrop-filter:blur(8px)}

  @media (max-width: 1024px){
    :root{ --fs:13px; --fs-small:11px; }
    .sidebar{width:300px}
    .toolbar{left:316px}
  }
  @media (max-width: 820px){
    .toolbar{position:static; margin:10px}
  }
</style>
</head>
<body>
  <div class="sidebar">
    <div class="panel">
      <h1>콘솔</h1>
      <div class="row">
        <span class="chip">리드</span>
        <select id="leadSelect"></select>
        <button id="homeBtn" class="ghost">뷰 리셋</button>
        <button id="panicBtn" class="danger">비상 복구</button>
      </div>

      <div class="sep"></div>
      <div class="row">
        <label>정면 밝기 <input id="intFront" type="range" min="0" max="12" step="0.1" value="8"></label>
        <label>사이드 <input id="intSide"  type="range" min="0" max="12" step="0.1" value="6"></label>
        <label>탑 <input id="intTop"   type="range" min="0" max="12" step="0.1" value="6"></label>
      </div>
      <div class="row">
        <label>백 <input id="intBack"  type="range" min="0" max="12" step="0.1" value="4.6"></label>
        <label>리어 <input id="intRear"  type="range" min="0" max="12" step="0.1" value="6"></label>
        <label>팔로우 <input id="intFollow" type="range" min="0" max="12" step="0.1" value="10"></label>
      </div>
      <div class="row">
        <label>정면 색 <input id="cFront" type="color" value="#ffffff"></label>
        <label>사이드 색 <input id="cSide" type="color" value="#ffd089"></label>
        <label>탑 색 <input id="cTop" type="color" value="#b28aff"></label>
      </div>
      <div class="row">
        <label>백 색 <input id="cBack" type="color" value="#cfe0ff"></label>
        <label>리어 색 <input id="cRear" type="color" value="#ff3c6e"></label>
        <label>팔로우 색 <input id="cFollow" type="color" value="#ffffff"></label>
      </div>

      <div class="sep"></div>
      <div class="row">
        <label>노출 <input id="expo" type="range" min="1.0" max="2.0" step="0.01" value="1.5"></label>
        <label class="chip"><input id="softFog" type="checkbox" checked> 소프트 안개</label>
      </div>
    </div>

    <div class="panel">
      <h1>배우</h1>
      <div class="row">
        <button id="addActorBtn" class="ok">배우 추가</button>
        <button id="dupActorBtn" class="ghost">복제</button>
        <button id="delActorBtn" class="danger">삭제</button>
        <label>선택 <select id="actorSelect"></select></label>
      </div>
      <div class="sep"></div>
      <div class="row">
        <label>키(세로) <input id="scaleY" type="range" min="0.8" max="1.3" step="0.01" value="1.0"></label>
      </div>
      <div class="row">
        <label>재킷 <input id="colJacket" type="color" value="#1f2a44"></label>
        <label>셔츠  <input id="colShirt"  type="color" value="#e6edf7"></label>
        <label>바지  <input id="colPants"  type="color" value="#141a24"></label>
        <label>피부  <input id="colSkin"   type="color" value="#f2d5b3"></label>
      </div>
    </div>

    <div class="panel">
      <h1>배경</h1>
      <div class="row">
        <input id="stageImgFile" type="file" accept="image/*"/>
        <label class="chip"><input type="checkbox" id="stageImgOn"> 보이기</label>
        <label class="chip"><input type="checkbox" id="stageFrame"> 프레임</label>
      </div>
      <div class="row">
        <label>크기 <input id="stageScale" type="range" min="0.5" max="3" step="0.01" value="1.0"></label>
        <button id="stageReset" class="ghost">세트 초기화</button>
      </div>
    </div>
  </div>

  <div class="toolbar">
    <div class="toolcard">
      <span class="chip">네온</span>
      <input id="neonText" type="text" value="멤피스">
      <label>크기 <input id="neonSize" type="range" min="0.6" max="1.6" value="1.0" step="0.01"></label>
      <button id="applyNeon">적용</button>
    </div>
  </div>

  <canvas id="c"></canvas>

<script type="module">
import * as THREE from 'https://esm.sh/three@0.160.0';
import { OrbitControls } from 'https://esm.sh/three@0.160.0/examples/jsm/controls/OrbitControls.js';

const clamp=(v,min,max)=> Math.min(max, Math.max(min,v));
const $ = (id)=>document.getElementById(id);

/* ===== 기본 세팅 ===== */
const canvas = document.getElementById('c');
const renderer = new THREE.WebGLRenderer({canvas, antialias:true});
renderer.shadowMap.enabled = true;
renderer.toneMapping = THREE.ACESFilmicToneMapping;
renderer.toneMappingExposure = 1.5;
const scene = new THREE.Scene();
scene.background = new THREE.Color('#070a0f');
scene.fog = new THREE.FogExp2('#070a0f', 0.003);
const camera = new THREE.PerspectiveCamera(60, 2, 0.1, 120);
const HOME_POS = new THREE.Vector3(6.4,4.6,9.0);
camera.position.copy(HOME_POS);
const controls = new OrbitControls(camera, renderer.domElement);
controls.enableDamping = true; controls.target.set(0,1.25,0);
function onResize(){ const w=innerWidth,h=innerHeight; renderer.setSize(w,h,false); camera.aspect=w/h; camera.updateProjectionMatrix(); }
addEventListener('resize', onResize); onResize();

/* ===== 무대 ===== */
const stage = new THREE.Group(); scene.add(stage);
const floorMat = new THREE.MeshStandardMaterial({color:'#0e1320', roughness:.92});
const backMat  = new THREE.MeshStandardMaterial({color:'#0c111d', roughness:.95});
const floor = new THREE.Mesh(new THREE.PlaneGeometry(16,12), floorMat); floor.rotation.x=-Math.PI/2; floor.receiveShadow=true; stage.add(floor);
const backdrop = new THREE.Mesh(new THREE.PlaneGeometry(16,7), backMat); backdrop.position.set(0,3.5,-6); backdrop.receiveShadow=true; stage.add(backdrop);

/* 헤이즈 */
const hazeGeo=new THREE.BufferGeometry(); const COUNT=900; const pos=new Float32Array(COUNT*3);
for(let i=0;i<COUNT;i++){ pos[i*3]=(Math.random()-0.5)*16; pos[i*3+1]=Math.random()*6; pos[i*3+2]=-Math.random()*6; }
hazeGeo.setAttribute('position', new THREE.BufferAttribute(pos,3));
const hazePts=new THREE.Points(hazeGeo, new THREE.PointsMaterial({size:0.05,color:'#cfe3ff',opacity:.18,transparent:true}));
scene.add(hazePts);

/* 네온 간판 + 크기 슬라이더 */
let neonTex=null; const neonMat=new THREE.MeshBasicMaterial({transparent:true});
const neon=new THREE.Mesh(new THREE.PlaneGeometry(5.0,1.25), neonMat); neon.position.set(0,4.8,-5.8); scene.add(neon);
function makeNeonTexture(text, glow='#ff2f6a', fill='#ffd9e2'){
  const cnv=document.createElement('canvas'); cnv.width=1024; cnv.height=256; const ctx=cnv.getContext('2d');
  ctx.clearRect(0,0,cnv.width,cnv.height);
  ctx.font='bold 96px system-ui, Apple SD Gothic Neo, Arial'; ctx.textAlign='center'; ctx.textBaseline='middle';
  ctx.shadowColor=glow; ctx.shadowBlur=28; ctx.fillStyle=fill; ctx.fillText(text, cnv.width/2, cnv.height/2);
  const t=new THREE.CanvasTexture(cnv); t.anisotropy=8; t.needsUpdate=true; return t;
}
function updateNeon(text){ if(neonTex) neonTex.dispose(); neonTex=makeNeonTexture(text||' '); neonMat.map=neonTex; neonMat.needsUpdate=true; }
updateNeon($('neonText').value);
$('applyNeon').onclick=()=> updateNeon($('neonText').value);
$('neonSize').oninput=()=>{ const s=+$('neonSize').value; neon.scale.set(s,s,1); };

/* ===== 배우(리디자인) ===== */
function makeMaterials(base){
  return {
    jacket:new THREE.MeshStandardMaterial({color:base.jacket, roughness:.55, metalness:.25}),
    shirt :new THREE.MeshStandardMaterial({color:base.shirt , roughness:.85}),
    pants :new THREE.MeshStandardMaterial({color:base.pants , roughness:.7}),
    shoes :new THREE.MeshStandardMaterial({color:'#0b0d12', roughness:.45, metalness:.05}),
    skin  :new THREE.MeshStandardMaterial({color:base.skin  , roughness:.55, metalness:.1})
  };
}
function createActor(x=0,z=0, baseColors={jacket:'#1f2a44',shirt:'#e6edf7',pants:'#141a24',skin:'#f2d5b3'}){
  const mats=makeMaterials(baseColors);
  const root=new THREE.Group(); root.position.set(x,0,z); scene.add(root);

  // 바닥 마커
  const base=new THREE.Group(); root.add(base);
  const plate=new THREE.Mesh(new THREE.CylinderGeometry(0.48,0.48,0.02,32), new THREE.MeshStandardMaterial({color:'#161b27',metalness:.2,roughness:.7}));
  plate.position.y=0.01; plate.receiveShadow=true; base.add(plate);
  const ring=new THREE.Mesh(new THREE.RingGeometry(0.50,0.62,48), new THREE.MeshBasicMaterial({color:'#7aa2ff',transparent:true,opacity:0.9}));
  ring.rotation.x=-Math.PI/2; ring.position.y=0.025; ring.visible=false; base.add(ring);
  const hit=new THREE.Mesh(new THREE.CylinderGeometry(0.5,0.5,0.05,24), new THREE.MeshBasicMaterial({color:0xffffff,transparent:true,opacity:0}));
  hit.position.y=0.03; base.add(hit);

  // 비율 기준
  const pelvisHeight = 1.0;      // 골반 위치
  const footY = 0.02;            // 발바닥 높이 (바닥 위 살짝)
  const legLen = 1.0;            // 다리 총 길이
  const calfLen = 0.5;
  const thighLen = legLen - calfLen;
  const torsoLen = 1.1;

  // 골격
  const hips=new THREE.Group(); hips.position.set(0,pelvisHeight,0); root.add(hips);

  // 하의(확실히 보이게 발 위치를 바닥에 맞춘다)
  const legGroup=new THREE.Group(); legGroup.position.set(0,0,0); hips.add(legGroup);
  const thighL =new THREE.Mesh(new THREE.BoxGeometry(0.22,thighLen,0.24), mats.pants); thighL.position.set(-0.18,-thighLen/2,0.02); thighL.castShadow=true;
  const thighR =new THREE.Mesh(new THREE.BoxGeometry(0.22,thighLen,0.24), mats.pants); thighR.position.set( 0.18,-thighLen/2,0.02); thighR.castShadow=true;
  const calfL  =new THREE.Mesh(new THREE.BoxGeometry(0.20,calfLen,0.22), mats.pants); calfL.position.set(-0.18,-thighLen-calfLen/2,0.02); calfL.castShadow=true;
  const calfR  =new THREE.Mesh(new THREE.BoxGeometry(0.20,calfLen,0.22), mats.pants); calfR.position.set( 0.18,-thighLen-calfLen/2,0.02); calfR.castShadow=true;
  const shoeH=0.12;
  const shoeL  =new THREE.Mesh(new THREE.BoxGeometry(0.28,shoeH,0.44), mats.shoes); shoeL.position.set(-0.18,-legLen - shoeH/2 + 0.02 + (pelvisHeight-1.0), 0.12); shoeL.castShadow=true;
  const shoeR  =new THREE.Mesh(new THREE.BoxGeometry(0.28,shoeH,0.44), mats.shoes); shoeR.position.set( 0.18,-legLen - shoeH/2 + 0.02 + (pelvisHeight-1.0), 0.12); shoeR.castShadow=true;
  legGroup.add(thighL, thighR, calfL, calfR, shoeL, shoeR);

  // 상체(셔츠 + 재킷 오픈형 + 라펠)
  const torso=new THREE.Group(); torso.position.set(0,0.6,0); hips.add(torso);
  torso.scale.y = 1.0;

  // 셔츠 몸통
  const shirt=new THREE.Mesh(new THREE.BoxGeometry(0.7, torsoLen, 0.46), mats.shirt ); shirt.castShadow=true; shirt.position.set(0,0.1, -0.02); torso.add(shirt);
  // 플래킷(앞여밈)
  const placket=new THREE.Mesh(new THREE.BoxGeometry(0.10, torsoLen, 0.03), mats.shirt); placket.position.set(0,0.1, 0.26); torso.add(placket);
  // 칼라
  const collarL=new THREE.Mesh(new THREE.BoxGeometry(0.20,0.06,0.14), mats.shirt); collarL.position.set(-0.16,0.58,0.25); collarL.rotation.z= 0.25; torso.add(collarL);
  const collarR=new THREE.Mesh(new THREE.BoxGeometry(0.20,0.06,0.14), mats.shirt); collarR.position.set( 0.16,0.58,0.25); collarR.rotation.z=-0.25; torso.add(collarR);

  // 재킷(오픈: 앞판 두 장 + 라펠 두 장 + 몸판)
  const jacketBack=new THREE.Mesh(new THREE.BoxGeometry(0.95, torsoLen+0.1, 0.30), mats.jacket); jacketBack.position.set(0,0.05,-0.1); jacketBack.castShadow=true; torso.add(jacketBack);
  const jacketLeft =new THREE.Mesh(new THREE.BoxGeometry(0.45, torsoLen, 0.08), mats.jacket); jacketLeft.position.set(-0.33,0.1,0.20); jacketLeft.rotation.y= 0.10; jacketLeft.castShadow=true; torso.add(jacketLeft);
  const jacketRight=new THREE.Mesh(new THREE.BoxGeometry(0.45, torsoLen, 0.08), mats.jacket); jacketRight.position.set( 0.33,0.1,0.20); jacketRight.rotation.y=-0.10; jacketRight.castShadow=true; torso.add(jacketRight);
  const lapelL=new THREE.Mesh(new THREE.BoxGeometry(0.22,0.35,0.04), mats.jacket); lapelL.position.set(-0.18,0.45,0.28); lapelL.rotation.set(0,0.05,0.12); torso.add(lapelL);
  const lapelR=new THREE.Mesh(new THREE.BoxGeometry(0.22,0.35,0.04), mats.jacket); lapelR.position.set( 0.18,0.45,0.28); lapelR.rotation.set(0,-0.05,-0.12); torso.add(lapelR);

  // 목/머리
  const neckGrp=new THREE.Group(); neckGrp.position.set(0,0.80,0); torso.add(neckGrp);
  const neck=new THREE.Mesh(new THREE.CylinderGeometry(0.11,0.11,0.16,16), mats.skin); neck.castShadow=true; neck.position.set(0,0.10,0); neckGrp.add(neck);
  const headGrp=new THREE.Group(); headGrp.position.set(0,0.25,0); neckGrp.add(headGrp);
  const head=new THREE.Mesh(new THREE.SphereGeometry(0.28,24,16), mats.skin); head.castShadow=true; headGrp.add(head);

  // 팔(자켓 소매)
  function arm(side=1){
    const g=new THREE.Group(); g.position.set(0.55*side, 0.35, 0); torso.add(g);
    const upper=new THREE.Mesh(new THREE.BoxGeometry(0.22,0.14,0.42), mats.jacket); upper.castShadow=true;
    const fore=new THREE.Mesh(new THREE.BoxGeometry(0.18,0.12,0.36), mats.jacket); fore.castShadow=true; fore.position.set(0,0,0.40);
    const cuff=new THREE.Mesh(new THREE.BoxGeometry(0.22,0.09,0.06), mats.shirt); cuff.position.set(0,0,0.62);
    const hand=new THREE.Mesh(new THREE.SphereGeometry(0.11,16,12), mats.skin); hand.castShadow=true; hand.position.set(0,0,0.70);
    g.add(upper, fore, cuff, hand);
    return g;
  }
  const L=arm(-1), R=arm(1);

  return {root, ring, hit, headGrp, torso, materials:mats, parts:{shirt,placket,collarL,collarR,jacketBack,jacketLeft,jacketRight,lapelL,lapelR}};
}

const actors=[]; let activeIndex=0;
const actorSelect=$('actorSelect'); const leadSelect=$('leadSelect');
function refreshActorOptions(){
  const prevA=actorSelect.value, prevL=leadSelect.value;
  actorSelect.innerHTML=''; leadSelect.innerHTML='';
  actors.forEach((_,i)=>{
    const t=`배우 ${i+1}`;
    const oa=document.createElement('option'); oa.value=String(i); oa.textContent=t; actorSelect.appendChild(oa);
    const ol=document.createElement('option'); ol.value=String(i); ol.textContent=t; leadSelect.appendChild(ol);
  });
  actorSelect.value = String(Math.min(+prevA||0, actors.length-1));
  leadSelect.value  = String(Math.min(+prevL||0, actors.length-1));
}
function setActive(i){
  activeIndex=i; actors.forEach((a,idx)=> a.ring.visible = idx===i); actorSelect.value=String(i);
  const m=actors[i].materials;
  $('colJacket').value = '#'+m.jacket.color.getHexString();
  $('colShirt').value  = '#'+m.shirt.color.getHexString();
  $('colPants').value  = '#'+m.pants.color.getHexString();
  $('colSkin').value   = '#'+m.skin.color.getHexString();
  $('scaleY').value    = actors[i].torso.scale.y.toFixed(2);
}
function addActor(){
  const i=actors.length;
  const offset=1.6; const x = i===0?0 : ((i%2)? -offset*Math.ceil(i/2) : offset*Math.ceil(i/2));
  const a=createActor(x,0);
  actors.push(a); setActive(actors.length-1); refreshActorOptions(); retargetLights();
}
$('addActorBtn').onclick=addActor;
$('dupActorBtn').onclick=()=>{ if(!actors.length) return; const src=actors[activeIndex]; const a=createActor(src.root.position.x+0.6, src.root.position.z+0.2, {jacket:'#29334d',shirt:'#e6edf7',pants:'#1b2230',skin:'#f0c8a0'}); actors.push(a); setActive(actors.length-1); refreshActorOptions(); retargetLights(); };
$('delActorBtn').onclick=()=>{ if(!actors.length) return; const a=actors.splice(activeIndex,1)[0]; scene.remove(a.root); a.root.traverse(o=>o.geometry?.dispose?.()); refreshActorOptions(); setActive(Math.max(0,activeIndex-1)); retargetLights(); };
actorSelect.onchange=()=> setActive(+actorSelect.value);
leadSelect.onchange=retargetLights;

['colJacket','colShirt','colPants','colSkin'].forEach(id=> $(id).addEventListener('input', ()=>{
  const ac=actors[activeIndex]; if(!ac) return;
  ac.materials.jacket.color.set($('colJacket').value);
  ac.materials.shirt.color.set($('colShirt').value);
  ['placket','collarL','collarR'].forEach(k=> ac.parts[k].material.color.set($('colShirt').value));
  ac.materials.pants.color.set($('colPants').value);
  ac.materials.skin.color.set($('colSkin').value);
}));
$('scaleY').oninput=()=>{ const ac=actors[activeIndex]; if(!ac) return; ac.torso.scale.y = +$('scaleY').value; };

/* ===== 조명 + 빔 (항상 표시) ===== */
function makeSpot(color,intensity,angleDeg,pos){
  const s=new THREE.SpotLight(color,intensity,50,THREE.MathUtils.degToRad(angleDeg),.35,1.6);
  s.position.copy(pos); s.castShadow=true; scene.add(s);
  const coneGeo=new THREE.ConeGeometry(0.001,1,24,1,true);
  const mat=new THREE.MeshBasicMaterial({color,transparent:true,opacity:0.22,depthWrite:false,blending:THREE.AdditiveBlending});
  const cone=new THREE.Mesh(coneGeo,mat); cone.renderOrder = 1;
  const beam=new THREE.Group(); beam.add(cone); scene.add(beam);
  function updateBeam(){
    const ang = s.angle;
    const h = (s.position.y - 0.02);
    const rad = Math.tan(ang)*h;
    cone.geometry.dispose();
    cone.geometry = new THREE.ConeGeometry(Math.max(0.01, rad), Math.max(0.5,h), 28, 1, true);
    beam.position.copy(s.position);
    beam.lookAt((s.target?.position)||new THREE.Vector3(0,0,0));
    mat.color.copy(s.color); mat.opacity = 0.22;
  }
  s._updateBeam=updateBeam; return s;
}
const H=new THREE.HemisphereLight('#e7efff','#0a0d14',0.42); scene.add(H);
const frontA=makeSpot('#ffffff',8,20,new THREE.Vector3(-3.6,6.2,2.6));
const frontB=makeSpot('#ffffff',8,20,new THREE.Vector3( 3.6,6.2,2.6));
const sideL =makeSpot('#ffffff',6,22,new THREE.Vector3(-6.0,2.5,0.6));
const sideR =makeSpot('#ffffff',6,22,new THREE.Vector3( 6.0,2.5,0.6));
const top1  =makeSpot('#ffffff',6,18,new THREE.Vector3(-2.5,7.0,2.6));
const top2  =makeSpot('#ffffff',6,18,new THREE.Vector3( 2.5,7.0,2.6));
const back1 =makeSpot('#ffffff',4.6,20,new THREE.Vector3(-1.2,6.2,-5.2));
const back2 =makeSpot('#ffffff',4.6,20,new THREE.Vector3( 1.2,6.2,-5.2));
const rearL =makeSpot('#ffffff',6,14,new THREE.Vector3(-5.2,3.0,-5.8));
const rearR =makeSpot('#ffffff',6,14,new THREE.Vector3( 5.2,3.0,-5.8));
const follow=makeSpot('#ffffff',10,16,new THREE.Vector3(0,7.4,7.0));

function retargetLights(){
  const lead=actors[+leadSelect.value||0];
  const center = new THREE.Vector3(0,1.25,0);
  const t = lead ? lead.root.position.clone().add(new THREE.Vector3(0,1.25,0)) : center;
  [frontA,frontB,sideL,sideR,top1,top2,back1,back2,rearL,rearR].forEach(l=>{
    if(!l.target){ l.target=new THREE.Object3D(); scene.add(l.target); }
    l.target.position.copy(t);
    l._updateBeam && l._updateBeam();
  });
  if(lead){
    if(!follow.target){ follow.target=new THREE.Object3D(); scene.add(follow.target); }
    const headW=new THREE.Vector3(); lead.headGrp.getWorldPosition(headW);
    follow.target.position.copy(headW);
    follow._updateBeam && follow._updateBeam();
  }
}
leadSelect.onchange=retargetLights;

/* 콘솔 적용 */
function applyConsole(){
  frontA.intensity=frontB.intensity=+$('intFront').value;
  sideL.intensity=sideR.intensity=+$('intSide').value;
  [top1,top2].forEach(s=> s.intensity=+$('intTop').value);
  back1.intensity=back2.intensity=+$('intBack').value;
  rearL.intensity=rearR.intensity=+$('intRear').value;
  follow.intensity=+$('intFollow').value;

  const cf=new THREE.Color($('cFront').value), cs=new THREE.Color($('cSide').value), ct=new THREE.Color($('cTop').value), cb=new THREE.Color($('cBack').value), cr=new THREE.Color($('cRear').value), cfo=new THREE.Color($('cFollow').value);
  frontA.color.copy(cf); frontB.color.copy(cf);
  sideL.color.copy(cs);  sideR.color.copy(cs);
  top1.color.copy(ct);   top2.color.copy(ct);
  back1.color.copy(cb);  back2.color.copy(cb);
  rearL.color.copy(cr);  rearR.color.copy(cr);
  follow.color.copy(cfo);

  [frontA,frontB,sideL,sideR,top1,top2,back1,back2,rearL,rearR,follow].forEach(s=> s._updateBeam && s._updateBeam());

  renderer.toneMappingExposure=clamp(+$('expo').value, 1.0, 2.0);
  scene.fog.density = $('softFog').checked ? 0.003 : 0.0;
  hazePts.material.opacity = $('softFog').checked ? 0.18 : 0.0;
}
['intFront','intSide','intTop','intBack','intRear','intFollow','cFront','cSide','cTop','cBack','cRear','cFollow','expo','softFog'].forEach(id=> $(id).addEventListener('input', applyConsole));

/* ===== 배경 이미지: 업로드 + 드래그 ===== */
const texLoader = new THREE.TextureLoader();
const stageGroup = new THREE.Group(); scene.add(stageGroup);
const imgPlane = new THREE.Mesh(new THREE.PlaneGeometry(6,3.5), new THREE.MeshBasicMaterial({color:'#ffffff'}));
imgPlane.position.set(0,2,-3); imgPlane.visible=false; stageGroup.add(imgPlane);
const shadowPlane = new THREE.Mesh(new THREE.PlaneGeometry(6,2.2), new THREE.MeshBasicMaterial({color:'#000000',transparent:true,opacity:0.18}));
shadowPlane.rotation.x = -Math.PI/2; shadowPlane.position.set(0,0.01,-3); shadowPlane.visible=true; stage.add(shadowPlane);
const frameGroup = new THREE.Group(); frameGroup.visible=false; stageGroup.add(frameGroup);
let stageScaleVal = 1.0;
function setStageScale(s){
  stageScaleVal = clamp(s, 0.5, 3);
  imgPlane.scale.set(stageScaleVal, stageScaleVal, 1);
  shadowPlane.scale.set(stageScaleVal, 1, stageScaleVal);
  $('stageScale').value = stageScaleVal;
}
function applyStageImage(url){
  texLoader.load(url, (tex)=>{
    tex.colorSpace = THREE.SRGBColorSpace;
    imgPlane.material.map = tex; imgPlane.material.needsUpdate=true;
    imgPlane.visible = $('stageImgOn').checked = true;
    frameGroup.visible = $('stageFrame').checked;
    setStageScale(stageScaleVal);
  });
}
$('stageImgFile').onchange=()=>{ const f = $('stageImgFile').files?.[0]; if(!f) return; applyStageImage(URL.createObjectURL(f)); };
['stageImgOn','stageFrame'].forEach(id=> $(id).addEventListener('change', ()=>{
  imgPlane.visible = $('stageImgOn').checked;
  frameGroup.visible = $('stageImgOn').checked && $('stageFrame').checked;
}));
$('stageScale').oninput=()=> setStageScale(+$('stageScale').value);
$('stageReset').onclick=()=>{ imgPlane.position.set(0,2,-3); setStageScale(1.0); frameGroup.position.copy(imgPlane.position); };

/* ===== 선택/드래그: 배우 & 세트 (드래그 중 카메라 고정) ===== */
const raycaster=new THREE.Raycaster(); const mouse=new THREE.Vector2();
const drag={active:false, type:null, plane:new THREE.Plane(new THREE.Vector3(0,1,0),0), offset:new THREE.Vector3(), target:null};
function setDragTarget(obj, type){
  drag.active=true; drag.type=type; drag.target=obj;
  const p=obj.position.clone();
  drag.plane.set(new THREE.Vector3(0,1,0), -p.y);
  const isect=new THREE.Vector3(); raycaster.ray.intersectPlane(drag.plane,isect);
  drag.offset.copy(isect).sub(p);
  canvas.style.cursor='grabbing';
  controls.enabled=false;
}
function clearDrag(){
  drag.active=false; drag.type=null; drag.target=null; canvas.style.cursor=''; controls.enabled=true;
}
function pick(e){
  const rect=canvas.getBoundingClientRect(); mouse.x=((e.clientX-rect.left)/rect.width)*2-1; mouse.y=-((e.clientY-rect.top)/rect.height)*2+1;
  raycaster.setFromCamera(mouse,camera);
  const hits = imgPlane.visible ? raycaster.intersectObject(imgPlane, false) : [];
  if(hits.length){ return {type:'set', obj:imgPlane}; }
  const aHits=raycaster.intersectObjects(actors.map(a=>a.hit), false);
  if(aHits.length){ const idx=actors.findIndex(a=>a.hit===aHits[0].object); if(idx>=0) setActive(idx); return {type:'actor', obj:actors[idx].root}; }
  return null;
}
canvas.addEventListener('mousedown',(e)=>{
  const p=pick(e);
  if(p){ setDragTarget(p.obj, p.type); }
});
canvas.addEventListener('mousemove',(e)=>{
  if(!drag.active || !drag.target) return;
  const rect=canvas.getBoundingClientRect(); mouse.x=((e.clientX-rect.left)/rect.width)*2-1; mouse.y=-((e.clientY-rect.top)/rect.height)*2+1;
  raycaster.setFromCamera(mouse,camera);
  const isect=new THREE.Vector3();
  if(raycaster.ray.intersectPlane(drag.plane,isect)){
    const p=isect.sub(drag.offset);
    if(drag.type==='actor'){
      drag.target.position.x=p.x; drag.target.position.z=p.z;
    }else if(drag.type==='set'){
      if(e.shiftKey){ drag.target.position.y = Math.max(0.2, p.y); }
      else { drag.target.position.x=p.x; drag.target.position.z=p.z; }
      shadowPlane.position.set(drag.target.position.x, 0.01, drag.target.position.z);
      frameGroup.position.copy(drag.target.position);
    }
  }
});
addEventListener('mouseup',clearDrag);
canvas.addEventListener('mouseleave',clearDrag);
canvas.addEventListener('wheel',(e)=>{ if(imgPlane.visible){ const d=e.deltaY>0?-0.05:0.05; setStageScale(stageScaleVal + d); } });

/* ===== 콘솔 적용 ===== */
function applyAll(){ applyConsole(); retargetLights(); }
applyAll();

/* ===== 홈/비상 복구 ===== */
$('homeBtn').onclick=()=>{ camera.position.copy(HOME_POS); controls.target.set(0,1.25,0); controls.update(); };
$('panicBtn').onclick=()=>{
  $('expo').value=1.5; $('softFog').checked=true;
  $('cFront').value='#6ea6ff'; $('cSide').value='#ffd089'; $('cTop').value='#b28aff'; $('cBack').value='#d0e0ff'; $('cRear').value='#ff3c6e'; $('cFollow').value='#ffffff';
  $('intFront').value=8; $('intSide').value=6; $('intTop').value=6; $('intBack').value=4.6; $('intRear').value=6; $('intFollow').value=10;
  actors.forEach((a,i)=>{ a.root.position.set((i?1.6:-1.6),0,0); a.torso.scale.y=1.0; });
  setActive(0); applyAll(); $('homeBtn').onclick();
};

/* ===== 초기 ===== */
function boot(){
  addActor(); addActor(); refreshActorOptions(); leadSelect.value='0';
  applyAll();
}
boot();

/* ===== 루프 ===== */
function loop(){
  retargetLights();
  controls.update();
  renderer.render(scene,camera);
  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);
</script>
</body>
</html>
